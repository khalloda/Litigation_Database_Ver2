# ADR 006: Restorable Trash System (Snapshot Bundles)

**Date**: 2025-10-08  
**Status**: Accepted  
**Decision Makers**: Development Team  

## Context

The Central Litigation Management application handles critical legal data including:
- Client records with complex relationship graphs
- Legal cases with hearings, tasks, and documents
- Supporting entities (contacts, engagement letters, POAs)

Users may accidentally delete important records. While Laravel's soft deletes provide basic recovery, they have limitations:
- No easy way to restore an entire relationship graph
- No visibility into what was deleted
- No conflict resolution when restoring
- No file tracking for deleted documents
- Difficult to manage and bulk-purge old deletions

We need an enterprise-grade "Recycle Bin" system that:
1. Captures deletion snapshots including all related entities
2. Preserves file references
3. Allows selective restoration with conflict resolution
4. Provides admin UI for managing deleted items
5. Supports TTL-based auto-purge

## Decision

We will implement a **Snapshot Bundle System** on top of Laravel's soft deletes, consisting of:

### Core Components
1. **Deletion Bundles** (`deletion_bundles` table) — Container for deletion snapshots
2. **Bundle Items** (`deletion_bundle_items` table) — Individual item tracking
3. **Collector Pattern** — Model-specific snapshot collection logic
4. **DeletionBundleService** — Business logic for create/restore/purge
5. **InteractsWithDeletionBundles** trait — Auto-capture on model deletion
6. **CLI Commands** — `trash:list`, `trash:restore`, `trash:purge`
7. **Web UI** — Admin interface for managing bundles

### Supported Root Types
All core domain models create bundles:
- **Client** (cascade: cases, hearings, tasks, contacts, documents, etc.)
- **CaseModel** (cascade: hearings, tasks, subtasks, documents)
- **ClientDocument** (single entity + file references)
- **Hearing** (single entity + parent references)
- **AdminTask** (includes subtasks)
- **AdminSubtask** (single entity + task reference)
- **EngagementLetter** (single entity + client reference)
- **PowerOfAttorney** (single entity + client reference)
- **Contact** (single entity + client reference)
- **Lawyer** (single entity + assignment metadata)

### Data Storage
- **Snapshot JSON**: Complete entity graph with all attributes
- **Files JSON**: File descriptors (disk, path, size, MIME)
- **Status Tracking**: trashed → restored/purged
- **Metadata**: Deleted by, reason, restore notes, TTL

### Restore Strategies
- **Dry Run**: Simulate restoration without applying changes
- **Conflict Resolution**:
  - `skip`: Don't restore if ID exists
  - `overwrite`: Update existing record
  - `new_copy`: Create with new ID
- **Orphan Handling**: Skip restoration if parent doesn't exist

## Rationale

### Why Snapshot Bundles?

1. **Data Integrity**: Captures complete relationship graph atomically
2. **Auditability**: Full history of what was deleted and why
3. **Flexibility**: Supports complex restore scenarios with conflict resolution
4. **Discoverability**: Admin UI makes deletions visible and manageable
5. **Compliance**: Audit trail for regulatory requirements
6. **Performance**: Indexed queries, paginated lists, batch operations

### Why Collectors?

1. **Extensibility**: Easy to add new model types
2. **Customization**: Each model defines what to snapshot
3. **Separation of Concerns**: Collection logic separate from service
4. **Testing**: Collectors can be tested independently

### Why Keep Soft Deletes?

1. **Performance**: Soft deletes are faster (no JSON serialization)
2. **Compatibility**: Works with existing Laravel features
3. **Layered Safety**: Bundles add extra recovery layer
4. **Query Scopes**: Can query only-trashed vs bundle-trashed

## Implementation Details

### Automatic Bundle Creation
```php
// Simply delete a model - bundle auto-created via trait
$client->delete();

// Skip bundle creation if needed
$model->skipBundleCreation = true;
$model->delete();

// Force delete bypasses bundles
$model->forceDelete();
```

### Manual Restoration
```php
// Via service
$service = app(DeletionBundleService::class);
$report = $service->restoreBundle($bundleId, [
    'dry_run' => false,
    'resolve_conflicts' => 'skip'
]);

// Via CLI
php artisan trash:restore {bundle-uuid} --dry-run
php artisan trash:restore {bundle-uuid} --resolve-conflicts=overwrite

// Via Web UI
Visit /trash, click Restore button
```

### Auto-Purge
```php
// Via CLI (cron job)
php artisan trash:purge --older-than=90
```

## Consequences

### Positive
- **User Safety**: Accidental deletions easily recoverable
- **Admin Control**: Central place to manage all deletions
- **Compliance**: Full audit trail with reasoning
- **Flexibility**: Supports complex multi-model restorations
- **Testing**: Comprehensive test coverage ensures reliability
- **Performance**: Efficient indexing and pagination

### Negative
- **Storage Overhead**: JSON snapshots consume disk space
- **Code Complexity**: Additional service layer and collectors
- **Maintenance**: Need to update collectors when schema changes
- **Memory**: Large graphs (Client with 100+ cases) consume memory during snapshot

### Mitigations
- **TTL-based purge**: Auto-cleanup after 90 days
- **Lazy loading**: Don't restore full graph unless needed
- **Batch operations**: CLI supports bulk purge
- **Monitoring**: Log bundle sizes and alert on large snapshots

## Alternatives Considered

1. **Soft Deletes Only**: Too basic, no relationship tracking
2. **Audit Log Reconstruction**: Complex, incomplete, no files
3. **Database Backups**: Too coarse-grained, restore entire DB
4. **Event Sourcing**: Overkill for this use case
5. **Third-Party SaaS**: Security concerns, cost

## Future Enhancements

- **File Quarantine**: Copy deleted files to separate storage
- **Restore Preview**: Visual diff before applying
- **Partial Restoration**: Select which items to restore
- **Export Bundles**: Download as JSON for external backup
- **Smart Conflict Resolution**: AI-suggested merge strategies

## References

- Laravel Soft Deletes: https://laravel.com/docs/10.x/eloquent#soft-deleting
- Project Requirements: Trash System Prompt, NFRs (Security, Reliability)
- Implementation: `/docs/runbooks/Trash_Restore_Runbook.md`

---

## Change Log

| Date | Version | Changes |
|---|---|---|
| 2025-10-08 | 1.0 | Initial ADR - Snapshot bundle system approved |

**Author**: AI Agent  
**Reviewers**: Pending human review

