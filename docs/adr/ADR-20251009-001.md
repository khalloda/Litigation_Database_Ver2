# ADR-001: Audit Logging Implementation

## Status
**Accepted** - 2025-10-09

## Context

The Central Litigation Management system requires comprehensive audit trails for:
- **Compliance** - Legal and regulatory requirements
- **Security** - Tracking unauthorized access and changes
- **Debugging** - Troubleshooting data inconsistencies
- **Accountability** - Who changed what and when
- **Data Governance** - Understanding data lineage and changes

### Requirements
- Track all CRUD operations on core entities
- Capture user attribution (who performed the action)
- Store change details (what fields changed, old vs new values)
- Provide searchable and filterable interface
- Support export for external compliance tools
- Maintain logs for extended retention periods (7 years for litigation)

### Constraints
- Must integrate with existing Laravel 10.x application
- Should not impact application performance significantly
- Must respect existing RBAC permissions
- Should be configurable and maintainable

## Decision

We will implement **Spatie ActivityLog** as the primary audit logging solution with the following architecture:

### **1. Core Package**
- **Spatie Laravel ActivityLog** - Mature, well-maintained Laravel package
- **Automatic logging** via Eloquent model traits
- **Configurable field tracking** per model
- **Built-in performance optimizations**

### **2. Implementation Strategy**

#### **A. Model Integration**
```php
// Add to all core models
use Spatie\Activitylog\Traits\LogsActivity;
use Spatie\Activitylog\LogOptions;

class Client extends Model
{
    use LogsActivity;
    
    public function getActivitylogOptions(): LogOptions
    {
        return LogOptions::defaults()
            ->logOnly(['client_name_ar', 'client_name_en', 'status'])
            ->logOnlyDirty() // Only log changed fields
            ->dontSubmitEmptyLogs()
            ->useLogName('client')
            ->setDescriptionForEvent(fn($event) => "Client was {$event}");
    }
}
```

#### **B. Database Schema**
- **activity_log** table with standard Spatie structure
- **JSON properties** field for flexible change storage
- **Indexes** on frequently queried fields (subject_type, causer_id, created_at)

#### **C. Web Interface**
- **AuditLogController** with filtering and search
- **Bootstrap 5 responsive views**
- **Export functionality** (CSV)
- **Detailed activity views**

#### **D. Security Integration**
- **RBAC integration** - requires `admin.audit.view` permission
- **Authentication required** for all audit log access
- **No sensitive data logging** - exclude passwords, tokens

### **3. Configuration**

#### **Retention Policy**
```php
// config/activitylog.php
'delete_records_older_than_days' => 2555, // 7 years
'enabled' => env('ACTIVITY_LOGGER_ENABLED', true),
```

#### **Field Selection**
- **Business-critical fields** - names, statuses, dates, amounts
- **Relationship fields** - foreign keys, associations
- **Exclude sensitive data** - passwords, tokens, private notes
- **Performance optimization** - limit to essential fields only

## Consequences

### **Positive**
- ✅ **Comprehensive audit trails** for all core entities
- ✅ **User attribution** - know who made changes
- ✅ **Change tracking** - what fields changed and how
- ✅ **Searchable interface** - find specific activities quickly
- ✅ **Export capability** - integrate with external compliance tools
- ✅ **Performance optimized** - only log dirty fields
- ✅ **Mature package** - well-tested and maintained
- ✅ **Laravel integration** - seamless with existing codebase

### **Negative**
- ❌ **Database growth** - audit logs will consume significant storage
- ❌ **Performance impact** - additional writes on every model change
- ❌ **Complexity** - additional configuration and maintenance
- ❌ **Storage costs** - 7-year retention requires planning

### **Neutral**
- **Learning curve** - team needs to understand audit log structure
- **Monitoring required** - need to monitor log volume and performance
- **Backup considerations** - audit logs must be included in backups

## Implementation Details

### **Phase 1: Core Setup** ✅
- [x] Install and configure Spatie ActivityLog
- [x] Add LogsActivity trait to all core models
- [x] Configure field selection and logging options
- [x] Create activity_log table migration

### **Phase 2: Web Interface** ✅
- [x] Create AuditLogController with filtering
- [x] Build responsive audit log views
- [x] Add search and export functionality
- [x] Integrate with RBAC permissions

### **Phase 3: Testing & Documentation** ✅
- [x] Create comprehensive test suite
- [x] Write runbook documentation
- [x] Create ADR documentation
- [x] Test performance with real data

### **Phase 4: Monitoring & Maintenance**
- [ ] Set up log volume monitoring
- [ ] Create cleanup procedures
- [ ] Document troubleshooting guides
- [ ] Train users on audit log interface

## Alternatives Considered

### **1. Custom Audit Solution**
**Pros**: Complete control, tailored to specific needs
**Cons**: Significant development time, maintenance burden, potential bugs
**Decision**: Rejected due to complexity and maintenance overhead

### **2. Laravel Built-in Events**
**Pros**: Native Laravel integration
**Cons**: Limited functionality, manual implementation required
**Decision**: Rejected due to insufficient features for compliance needs

### **3. Third-party SaaS Solutions**
**Pros**: Managed service, advanced features
**Cons**: External dependency, data privacy concerns, cost
**Decision**: Rejected due to data privacy and cost considerations

### **4. Database Triggers**
**Pros**: Database-level tracking, always active
**Cons**: Database-specific, limited change tracking, complex debugging
**Decision**: Rejected due to complexity and maintenance issues

## Monitoring & Metrics

### **Key Performance Indicators**
- **Log Volume**: Activities per hour/day
- **Storage Growth**: Database size increase rate
- **Query Performance**: Audit log page load times
- **Error Rate**: Failed audit log writes

### **Alerting Thresholds**
- **High Volume**: >1000 activities per hour
- **Storage**: >10GB audit log data
- **Performance**: >2 second page load times
- **Errors**: >1% failed audit writes

## Future Considerations

### **Potential Enhancements**
- **Real-time notifications** for critical changes
- **Advanced analytics** on audit patterns
- **Integration with SIEM** systems
- **Automated compliance reporting**
- **Audit log archiving** to cold storage

### **Scalability Planning**
- **Database partitioning** by date for large volumes
- **Read replicas** for audit log queries
- **Caching strategies** for frequently accessed logs
- **API endpoints** for programmatic access

---

## References

- [Spatie Laravel ActivityLog Documentation](https://spatie.be/docs/laravel-activitylog)
- [Laravel Eloquent Events](https://laravel.com/docs/eloquent#events)
- [GDPR Compliance Requirements](https://gdpr.eu/compliance/)
- [SOX Audit Trail Requirements](https://www.soxlaw.com/)

---

*Decision made by: Development Team*  
*Date: 2025-10-09*  
*Review Date: 2026-10-09*
