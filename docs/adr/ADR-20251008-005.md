# ADR 005: Storage Strategy â€” Secure Private Storage with Signed URLs

**Date**: 2025-10-08  
**Status**: Accepted  
**Decision Makers**: Development Team  

## Context

The application handles sensitive legal documents that require:
- Secure storage (not publicly accessible)
- Access control based on user permissions
- Protection against direct URL access
- File upload validation (size, MIME type)
- Metadata tracking (uploader, upload date, file name, size)
- Download tracking for audit purposes
- Maximum file size: 10 MB
- Support for common document formats (PDF, DOCX, XLSX, images)

## Decision

We will use **Laravel's private filesystem** (`storage/app/secure`) with **signed URL-based downloads** and **permission-checked controllers**.

## Rationale

1. **Security**: Files stored outside public directory, not directly accessible via URL
2. **Laravel Native**: Built-in Storage facade, no external dependencies
3. **Signed URLs**: Time-limited, tamper-proof download links
4. **Permission Integration**: Leverage Spatie Permission policies before serving files
5. **Flexibility**: Easy to switch to S3/cloud storage later if needed
6. **Audit Trail**: Download events can be logged via Spatie Activitylog

## Implementation Details

### Storage Configuration
- **Disk**: `secure` (custom disk in `config/filesystems.php`)
- **Root**: `storage/app/secure`
- **Visibility**: `private`
- **Driver**: `local` (can be swapped to `s3` later)

### Upload Flow
1. **Validation** (in Form Request):
   - Max file size: 10 MB (`max:10240`)
   - Allowed MIME types: `mimes:pdf,doc,docx,xls,xlsx,jpg,jpeg,png`
   - Virus scan (optional, via ClamAV or similar)

2. **Storage**:
   ```php
   $path = $request->file('document')->store('documents', 'secure');
   ```

3. **Database Record**:
   - Table: `client_documents` (or similar)
   - Columns: `file_name`, `file_path`, `mime_type`, `size`, `uploaded_by`, `uploaded_at`, `matter_id`, etc.

### Download Flow
1. **Route**: `Route::get('/documents/{document}/download', [DocumentController::class, 'download'])->name('documents.download')`
2. **Policy Check**: `$this->authorize('download', $document)`
3. **Signed URL** (optional, for links in emails):
   ```php
   URL::temporarySignedRoute('documents.download', now()->addHours(24), ['document' => $document->id])
   ```
4. **Serve File**:
   ```php
   return Storage::disk('secure')->download($document->file_path, $document->file_name);
   ```
5. **Log Activity**: Record download event with causer, IP, timestamp

### Directory Structure
```
storage/
  app/
    secure/
      documents/
        {year}/
          {month}/
            {uuid}.pdf
```

### Security Measures
- **No Direct Access**: `.htaccess` or nginx config prevents direct file access
- **Permission Checks**: All downloads require authenticated user with `documents.download` permission
- **Signed URLs**: For external sharing, short-lived signed URLs
- **File Validation**: MIME type verification, size limits
- **Audit Logging**: All uploads/downloads tracked

## Consequences

### Positive
- Strong security: files inaccessible without authorization
- Centralized access control
- Scalable to cloud storage (S3, etc.)
- Audit trail for compliance
- Easy to implement

### Negative
- Slightly increased server load (files served via PHP, not direct web server)
- Storage management needed (cleanup of orphaned files)

## Alternatives Considered

1. **Public Storage**: Insecure, files accessible via direct URL
2. **Database BLOB Storage**: Poor performance, large DB size
3. **Third-Party Storage** (Dropbox, Google Drive APIs): Unnecessary complexity

## References

- Laravel File Storage: https://laravel.com/docs/10.x/filesystem
- Signed URLs: https://laravel.com/docs/10.x/urls#signed-urls
- Project Requirements: Master Prompt T-07, NFRs (Security)

